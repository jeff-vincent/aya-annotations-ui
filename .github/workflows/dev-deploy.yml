name: Dev Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: "registry:5000"
  TAG: "${{ github.actor }}-${{ github.sha }}"

jobs:
  build-and-deploy:
    runs-on: [self-hosted, "${{ github.actor }}"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean builds directory
        shell: bash
        run: |
          rm -f /builds/*.done /builds/*.request /builds/*.processing \
                /builds/*.apply /builds/*.apply-done /builds/*.apply-log \
                /builds/*.apply-exitcode /builds/*.exitcode \
                /builds/*.log /builds/*.dest /builds/*.tar.gz \
                /builds/*.yaml /builds/*.sh

      # -- Build all images --

      - name: Patch frontend Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/frontend
          sed -i '/^FROM /a ENV npm_config_cache=/tmp/.npm' Dockerfile

      - name: Build frontend image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: frontend
          context: ${{ github.workspace }}/frontend
          image: "${{ env.REGISTRY }}/frontend:${{ env.TAG }}"

      - name: Patch backend Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/backend
          sed -i 's/poetry install/poetry install --no-root/g' Dockerfile

      - name: Build backend image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: backend
          context: ${{ github.workspace }}/backend
          image: "${{ env.REGISTRY }}/backend:${{ env.TAG }}"

      - name: Patch daily job Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/backend
          sed -i 's/poetry install/poetry install --no-root/g' jobs/daily/Dockerfile

      - name: Build daily job image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: daily-job
          context: ${{ github.workspace }}/backend
          dockerfile: jobs/daily/Dockerfile
          image: "${{ env.REGISTRY }}/daily-job:${{ env.TAG }}"

      - name: Patch weekly job Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/backend
          sed -i 's/poetry install/poetry install --no-root/g' jobs/weekly/Dockerfile

      - name: Build weekly job image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: weekly-job
          context: ${{ github.workspace }}/backend
          dockerfile: jobs/weekly/Dockerfile
          image: "${{ env.REGISTRY }}/weekly-job:${{ env.TAG }}"

      - name: Patch by language job Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/backend
          sed -i 's/poetry install/poetry install --no-root/g' jobs/by_language/Dockerfile

      - name: Build by language job image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: by-language-job
          context: ${{ github.workspace }}/backend
          dockerfile: jobs/by_language/Dockerfile
          image: "${{ env.REGISTRY }}/by-language-job:${{ env.TAG }}"

      - name: Patch overall job Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/backend
          sed -i 's/poetry install/poetry install --no-root/g' jobs/overall/Dockerfile

      - name: Build overall job image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: overall-job
          context: ${{ github.workspace }}/backend
          dockerfile: jobs/overall/Dockerfile
          image: "${{ env.REGISTRY }}/overall-job:${{ env.TAG }}"

      # -- Deploy in dependency order --

      - name: Deploy backend
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-backend"
          image: "${{ env.REGISTRY }}/backend:${{ env.TAG }}"
          port: "8080"
          ingress-host: "${{ github.actor }}-backend.localhost"
          health-check-path: "/actuator/health"
          labels: |
            app.kubernetes.io/part-of: aya-annotations-ui
            app.kubernetes.io/component: backend
            apps.example.com/github-username: ${{ github.actor }}
          dependencies: |
            - type: postgres
          env: |
            - name: INSTRUCT_MULTILINGUAL_APP_DB_URI
              valueFrom:
                secretKeyRef:
                  name: kindling-secret-instruct-multilingual-app-db-uri
                  key: value
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: kindling-secret-jwt-secret
                  key: value
            - name: JWT_ALGORITHM
              value: "HS256"
            - name: JWT_EXPIRATION_TIME
              value: "3600"
            - name: FRONTEND_URL
              value: "http://${{ github.actor }}-frontend:4000"
            - name: FOR_AI_URL
              value: "http://${{ github.actor }}-frontend:4000"
          replicas: 1
          service-type: ClusterIP
          ingress-class: nginx
          wait: true

      - name: Deploy frontend
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-frontend"
          image: "${{ env.REGISTRY }}/frontend:${{ env.TAG }}"
          port: "80"
          health-check-path: "/"
          labels: |
            app.kubernetes.io/part-of: aya-annotations-ui
            app.kubernetes.io/component: frontend
            apps.example.com/github-username: ${{ github.actor }}
          env: |
            - name: BACKEND_URL
              value: "http://${{ github.actor }}-backend:8080"
          ingress-host: "${{ github.actor }}-frontend.localhost"
          replicas: 1
          service-type: ClusterIP
          ingress-class: nginx
          wait: true

      - name: Deploy daily leaderboard job
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-daily-job"
          image: "${{ env.REGISTRY }}/daily-job:${{ env.TAG }}"
          port: "8080"
          ingress-host: "${{ github.actor }}-daily-job.localhost"
          labels: |
            app.kubernetes.io/part-of: aya-annotations-ui
            app.kubernetes.io/component: daily-job
            apps.example.com/github-username: ${{ github.actor }}
          dependencies: |
            - type: postgres
          replicas: 1
          service-type: ClusterIP
          ingress-class: nginx
          wait: true

      - name: Deploy weekly leaderboard job
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-weekly-job"
          image: "${{ env.REGISTRY }}/weekly-job:${{ env.TAG }}"
          port: "8080"
          ingress-host: "${{ github.actor }}-weekly-job.localhost"
          labels: |
            app.kubernetes.io/part-of: aya-annotations-ui
            app.kubernetes.io/component: weekly-job
            apps.example.com/github-username: ${{ github.actor }}
          dependencies: |
            - type: postgres
          replicas: 1
          service-type: ClusterIP
          ingress-class: nginx
          wait: true

      - name: Deploy by language leaderboard job
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-by-language-job"
          image: "${{ env.REGISTRY }}/by-language-job:${{ env.TAG }}"
          port: "8080"
          ingress-host: "${{ github.actor }}-by-language-job.localhost"
          labels: |
            app.kubernetes.io/part-of: aya-annotations-ui
            app.kubernetes.io/component: by-language-job
            apps.example.com/github-username: ${{ github.actor }}
          dependencies: |
            - type: postgres
          replicas: 1
          service-type: ClusterIP
          ingress-class: nginx
          wait: true

      - name: Deploy overall leaderboard job
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-overall-job"
          image: "${{ env.REGISTRY }}/overall-job:${{ env.TAG }}"
          port: "8080"
          ingress-host: "${{ github.actor }}-overall-job.localhost"
          labels: |
            app.kubernetes.io/part-of: aya-annotations-ui
            app.kubernetes.io/component: overall-job
            apps.example.com/github-username: ${{ github.actor }}
          dependencies: |
            - type: postgres
          replicas: 1
          service-type: ClusterIP
          ingress-class: nginx
          wait: true

      # NOTE: OAuth detected â€” run 'kindling expose' for a public HTTPS URL
